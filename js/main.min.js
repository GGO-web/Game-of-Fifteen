"use strict";

var gameField = document.getElementById("game-field"),
    gameFieldSizeWrapper = document.querySelector(".game-field-size-wrapper"),
    gameFieldSizeButtons = document.querySelectorAll(".game-field-size__button"),
    countMoves = document.getElementById("count-moves"),
    countTimes = document.getElementById("count-times"),
    gameRestart = document.getElementById("game-restart"),
    gameMenu = document.getElementById("game-menu"),
    gameWinModalWrapper = document.querySelector(".game-win-modal-wrapper"),
    gameWinCloseButton = document.querySelector(".game-win-modal__close-button");
var timer,
    countCells = +gameField.dataset.countcells,
    countRows = +Math.sqrt(countCells),
    emptyCellIndex = +countCells,
    moves = 0,
    isFirstClick = !0,
    timeLeft = 0;

var animationTimeStart = 350,
    animationTimeEnd = 250,
    normalizeTimeLeft = function normalizeTimeLeft(e) {
  if (!e.includes(".")) return e += ",0";
  var t = e.indexOf(".");
  var n = (e = e.substring(0, t) + "," + e.substring(t + 1)).length - t - 1;

  for (var _t = 0; _t < 1 - n; ++_t) {
    e += "0";
  }

  return e;
},
    createCells = function createCells() {
  for (var _e = 1; _e < countCells; ++_e) {
    var t = document.createElement("li");
    t.classList.add("game-field__cell"), t.dataset.index = _e, t.style.flexBasis = 100 / countRows + "%", t.innerHTML = _e, gameField.appendChild(t);
  }

  var e = document.createElement("li");
  e.classList.add("game-field__cell"), e.dataset.index = countCells, e.style.flexBasis = 100 / countRows + "%", gameField.appendChild(e);
},
    removeCells = function removeCells() {
  gameField.innerHTML = "";
},
    switchStates = function switchStates(e, t) {
  var n = gameField.querySelector(".game-field__cell:nth-child(".concat(e, ")")),
      l = gameField.querySelector(".game-field__cell:nth-child(".concat(t, ")")),
      i = n.innerHTML,
      o = l.innerHTML;
  n.innerHTML = o, l.innerHTML = i;
},
    isAdjacentCell = function isAdjacentCell(e) {
  if (e < 1 || e > countCells) return !1;
  var t = !0,
      n = !0,
      l = !0,
      i = !0;
  return e % countRows == 1 && (l = !1), e % countRows == 0 && (i = !1), e / countRows <= 1 && (t = !1), e / countRows > countRows - 1 && (n = !1), !(!l || emptyCellIndex !== e - 1) || !(!i || emptyCellIndex !== e + 1) || !(!t || emptyCellIndex !== e - countRows) || !(!n || emptyCellIndex !== e + countRows);
},
    closeGameFieldSize = function closeGameFieldSize() {
  gameFieldSizeWrapper.classList.add("hidden");
},
    openGameFieldSize = function openGameFieldSize() {
  gameFieldSizeWrapper.classList.remove("hidden");
},
    openGame = function openGame() {
  document.querySelector(".game-wrapper").classList.remove("hidden");
},
    closeGame = function closeGame() {
  document.querySelector(".game-wrapper").classList.add("hidden");
},
    openGameWinModal = function openGameWinModal() {
  gameWinModalWrapper.classList.remove("hidden");
},
    closeGameWinModal = function closeGameWinModal() {
  gameWinModalWrapper.classList.add("hidden");
},
    changeFieldSize = function changeFieldSize(e) {
  gameField.dataset.countcells = e;
},
    updateChanges = function updateChanges() {
  countCells = gameField.dataset.countcells, countRows = +Math.sqrt(countCells), emptyCellIndex = +countCells;
},
    resetCountMoves = function resetCountMoves() {
  countMoves.innerHTML = "-", moves = 0;
},
    updateCountMoves = function updateCountMoves() {
  moves++, countMoves.innerHTML = "" + moves;
},
    getRandomNumberFrom1to4 = function getRandomNumberFrom1to4() {
  return Math.ceil(4 * Math.random());
},
    getIndexOfCellByDirection = function getIndexOfCellByDirection(e) {
  var t = emptyCellIndex;

  switch (e) {
    case 1:
      t -= countRows;
      break;

    case 2:
      t++;
      break;

    case 3:
      t += countRows;
      break;

    case 4:
      t--;
  }

  return t;
},
    gameShuffle = function gameShuffle() {
  for (var e = 0; e <= 2021; ++e) {
    var _e2 = Math.ceil(4 * Math.random()),
        t = getIndexOfCellByDirection(_e2);

    isAdjacentCell(t) && (switchStates(emptyCellIndex, t), emptyCellIndex = t);
  }
},
    updateGameWinInfo = function updateGameWinInfo() {
  var e = document.querySelector(".game-win-modal__score"),
      t = document.querySelector(".game-win-modal__time");
  e.innerHTML = "" + moves, t.innerHTML = "" + normalizeTimeLeft(String(timeLeft));
},
    isGameWin = function isGameWin() {
  var e = gameField.querySelectorAll(".game-field__cell");

  for (var t = 0; t < countCells - 1; ++t) {
    if (+e[t].innerHTML != t + 1) return !1;
  }

  return !0;
},
    blockClicks = function blockClicks() {
  document.querySelectorAll(".game-field__cell").forEach(function (e) {
    e.style.pointerEvents = "none";
  });
},
    unBlockClicks = function unBlockClicks() {
  document.querySelectorAll(".game-field__cell").forEach(function (e) {
    e.style.pointerEvents = "all";
  });
},
    animationAfterWin = function animationAfterWin() {
  var e = Array.from({
    length: countCells
  }, function (e, t) {
    return t + 1;
  });

  for (var _t2 = 2; _t2 <= countRows; _t2 += 2) {
    var n = (_t2 - 1) * countRows,
        l = _t2 * countRows - 1;

    for (; n < l;) {
      var _t3 = e[n];
      e[n] = e[l], e[l] = _t3, n++, l--;
    }
  }

  document.querySelectorAll(".game-field__cell").forEach(function (e) {
    e.style.pointerEvents = "none";
  });
  var t = 350;

  var _loop = function _loop(_n) {
    var l = document.querySelector(".game-field__cell:nth-child(".concat(e[_n], ")"));
    l.style.transition = "background 0.3s ease-in-out", setTimeout(function () {
      l.style.background = "rgba(128, 128, 128, 0.9)";
    }, t), setTimeout(function () {
      l.style.background = "gray";
    }, t + 250), t += 350;
  };

  for (var _n = 0; _n < countCells; ++_n) {
    _loop(_n);
  }
},
    updateTimeOnGame = function updateTimeOnGame() {
  countTimes.innerHTML = normalizeTimeLeft(String(timeLeft)) + "s";
},
    resetTimeOnGame = function resetTimeOnGame() {
  countTimes.innerHTML = "0,0s", timeLeft = 0;
},
    startTimer = function startTimer() {
  timer = setInterval(function () {
    timeLeft = +(timeLeft + .1).toFixed(1), countTimes.innerHTML = normalizeTimeLeft(String(timeLeft)) + "s";
  }, 100);
},
    stopTimer = function stopTimer() {
  clearInterval(timer), isFirstClick = !0;
};

gameField.addEventListener("click", function (e) {
  var t = e.target,
      n = t.innerHTML;

  if (t.classList.contains("game-field__cell") && "" != n) {
    var _e3 = +t.dataset.index;

    if (isAdjacentCell(_e3) && (isFirstClick && (timer = setInterval(function () {
      timeLeft = +(timeLeft + .1).toFixed(1), countTimes.innerHTML = normalizeTimeLeft(String(timeLeft)) + "s";
    }, 100), isFirstClick = !1), moves++, countMoves.innerHTML = "" + moves, switchStates(_e3, emptyCellIndex), emptyCellIndex = _e3), isGameWin()) {
      animationAfterWin(), stopTimer();
      setTimeout(function () {
        closeGame(), document.querySelectorAll(".game-field__cell").forEach(function (e) {
          e.style.pointerEvents = "all";
        }), updateGameWinInfo(), gameWinModalWrapper.classList.remove("hidden");
      }, 350 * countCells + 250);
    }
  }
}), gameFieldSizeButtons.forEach(function (e) {
  e.addEventListener("click", function (e) {
    var t = e.target.dataset.size;
    var n;
    gameFieldSizeWrapper.classList.add("hidden"), openGame(), n = t, gameField.dataset.countcells = n, countCells = gameField.dataset.countcells, countRows = +Math.sqrt(countCells), emptyCellIndex = +countCells, createCells(), resetCountMoves(), resetTimeOnGame(), gameShuffle();
  });
}), gameRestart.addEventListener("click", function () {
  resetCountMoves(), resetTimeOnGame(), stopTimer(), gameShuffle();
}), gameMenu.addEventListener("click", function () {
  resetCountMoves(), resetTimeOnGame(), stopTimer(), closeGame(), gameField.innerHTML = "", gameFieldSizeWrapper.classList.remove("hidden");
}), gameWinCloseButton.addEventListener("click", function () {
  gameWinModalWrapper.classList.add("hidden"), resetCountMoves(), resetTimeOnGame(), stopTimer(), gameShuffle(), openGame();
});